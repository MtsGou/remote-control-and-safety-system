Codes containing development of remotely controlled robot and systems prototypes for autonomous vehicles technology, including emergency and security intelligence.

The Autonomous Emergency and Monitoring System (SEMA) is responsible for managing the actions to be taken in emergency situations, caused by general, hardware or software failures. The system consists of an electronic board with embedded application, using microcontrollers STM32L476RG from ST Microelectronics, whose processor is the ARM model 32-bit Cortex® M4, and ESP32, widely used in IoT applications, whose processor is the 32-bit Xtensa® Dual-Core LX6.

Under normal circumstances, this system takes no action andworks passively, without influencing navigation or navigation in any way.

SEMA is active in situations that it deems to be emergent, in terms of hardware and software, or if there is direct order from the CPU or the controller. SEMA has output pins whose signals are transmitted directly to the truck's electronic control units, the ECMs, exercising the
drive-by-wire function. SEMA signals are responsible for acting only in emergency cases, sending the necessary information to the brakes (emergency and delay) and to the accelerator, so that the truck brakes appropriately. The activation is done by relays, which, in normal position, select the UPA signals for the drive-by-wire outputs. When it becomes active, SEMA switches the relays, selecting for the outputs the signals generated by the SEMA microcontrollers or, in other cases, by oscillators (circuit integrated NE555).

<p align="center">
<img src="./pic/gif_autonomous.gif" />
</p>

## ESP32 MCU

[..]
    
    PINOUT:

    (#) CPU communication PINS:
      (*) IN_EXTRA_CPU: Recebimento de comandos do CPU para frear ou desativar freio.
                          1 -> Freio atuado. 0-> Freio nao atuado.
      (*) OUT_EXTRA_CPU: Envio de feedbacks para CPU apos atuacao.
                          1 -> Freio atuado. 0-> Freio nao atuado.
      (*) IN_PWM_CPU: Recebe o PWM indicativo do estado de funcionamento do CPU.

    (#) UPA communication PINS:
      (*) IN_PWM_UPA: Recebe o PWM indicativo do estado de funcionamento da UPA.

    (#) STM communication PINS:
      (*) IO_OUT_ESP_1: Recebimento de feedbacks do STM apos atuacao deste.
                          1 -> Freio atuado. 0-> Freio nao atuado.
      (*) IO_OUT_ESP_2: Envio de feedbacks para STM apos atuacao.
                          1 -> Freio atuado. 0-> Freio nao atuado.
      (*) OUT_PWM_ESP: Recebe o PWM indicativo do estado de funcionamento do STM.
      (*) IN_PWM_ESP: Envia um PWM indicativo do estado de funcionamento do ESP.
      (*) CONNECT_ESP_IN: Envia um sinal digital para informar a conexao do ESP.
                          1 -> conectado. 0-> nao conectado.
      (*) ESP_IN_CLIENTE: Envia um sinal digital indicando conexao dos clientes.
                        1 -> ao menos 1 cliente conectado. 0-> nao conectado.

    (#) Actuation pins:
      (*) RELE_FREIO_ESP: Saida digital responsavel por atuar o rele de freio.
      (*) FE_ESP: Geracao do PWM do freio de emergencia para a ECM do caminhao.
      (*) AC_ESP: Geracao do PWM do acelerador para a ECM do caminhao.

    (#) RESUMO:
        (+) Em condicoes normais, o rele nao esta atuado.
        (+) Recebimento de PWM indicativo de estado de funcionamento:
          - Feito por meio de pinos de interrupcao externa.
          - A interrupcao zera contadores.
          - Se os contadores ultrapassarem um limite,
            e entendido como falha.
        (+) Condicoes de atuacao:
          - Com falha do STM, ou
          - Com ordem direta do operador (cliente), ou
          - Com ordem direta do CPU, ou
          - Pelo despacho, ao receber comando em protocolo TCP
        (+) Na atuacao, o rele atua e envia para ECM os PWM gerados.
        (+) Um menu de configuracao pode ser acessado 
            na inicializacao (apenas).
          - Os parametros configurados podem ser salvos na flash.
          - Os parametros configurados podem ser apagados da flash.
          - A flash e manipulada com uso da biblioteca EEPROM.
        (+) Eventualidades sao informadas a todo momento por UART,
            contendo timestamp.
        (+) Conexao:
          - Tenta conectar a um AP WiFi na rede salva.
          - Deve estar na mesma rede do despacho.
          - O sistema funciona mesmo sem rede, porem, sem os
            recursos de freio remoto e monitoramento remoto.
          - Este software oferece dois servidores.
          - Servidor 1: porta 80. Comunica via socket com front-end.
          - Servidor 2: porta 8080. Comunica com despacho via TCP.
  */

## STM32 MCU


[..]
  *
  *  PINOUT:
  *
  *  (#) CPU communication PINS:
  *    (*) IN_CPU_6: Recebimento de comandos do CPU para frear ou desativar freio.
  *                        1 -> Freio atuado. 0-> Freio nao atuado.
  *    (*) FEEDBACK_CPU: Envio de feedbacks para CPU apos atuacao.
  *                        1 -> Freio atuado. 0-> Freio nao atuado.
  *    (*) IN_PWM_CPU: Recebe o PWM indicativo do estado de funcionamento do CPU.
  *    (*) PWM_OUT_CPU: Envia o PWM indicativo do estado de funcionamento do STM32.
  *    (*) GATE_FR: Habilita o ajuste do freio de retardo pelo CPU.
  *    (*) FR_BIT_1: Bit 1 do ajuste do freio de retardo pelo CPU.
  *    (*) FR_BIT_2: Bit 2 "									"
  *    (*) FR_BIT_3: Bit 3 "									"
  *    (*) FR_BIT_4: Bit 4 "									"
  *    (*) CPU_OUT_A: Primeiro pino para informar status do sistema para CPU.
  *    (*) CPU_OUT_B: Segundo pino "									"
  *    (*) CPU_OUT_C: Terceiro pino "									"
  *
  *
  *  (#) UPA communication PINS:
  *    (*) IN_PWM_UPA: Recebe o PWM indicativo do estado de funcionamento da UPA.
  *    (*) PWM_OUT_UPA: Envia o PWM indicativo do estado de funcionamento do STM32.
  *
  *  (#) ESP communication PINS:
  *    (*) IO_OUT_ESP_2: Recebimento de feedbacks do ESP apos atuacao deste.
  *                        1 -> Freio atuado. 0-> Freio nao atuado.
  *    (*) IO_OUT_ESP_1: Envio de feedbacks para ESP apos atuacao.
  *                        1 -> Freio atuado. 0-> Freio nao atuado.
  *    (*) OUT_PWM_ESP: Envia um PWM indicativo do estado de funcionamento do STM32.
  *    (*) IN_PWM_ESP: Recebe o PWM indicativo do estado de funcionamento do ESP.
  *    (*) CONNECT_ESP_IN: Recebe um sinal digital para informar a conexao do ESP.
  *                        1 -> conectado. 0-> nao conectado.
  *    (*) ESP_IN_CLIENTE: Recebe sinal digital do ESP indicando conexao dos clientes.
  *                      1 -> ao menos 1 cliente conectado. 0-> nao conectado.
  *
  *  (#) Actuation pins:
  *    (*) RELE_FREIO_STM: Saida digital responsavel por atuar o rele de freio.
  *    (*) FE_STM: Geracao do PWM do freio de emergencia para a ECM do caminhao.
  *    (*) AC_STM: Geracao do PWM do acelerador para a ECM do caminhao.
  *    (*) FR_STM: Geracao do PWM do freio de retardo para a ECM do caminhao.
  *    (*) ON_OFF_SWITCH: Pino para ligar o MUX
  *    (*) A_SWITCH: Pino A para trocar posicao do MUX.
  *    (*) B_SWITCH: Pino B "						   "
  *
  *  (#) Indication pins:
  *    (*) LED_GREEN: Led para indicar recebimento RX do radio (UART 3)
  *    (*) LED_RED: Led para indicar envio TX para radio (UART 3)
  *    (*) CHECK_FONTE: Indica o estado da bateria do caminhao.
  *    					1 -> Bateria OK. 0-> Falha na alimentacao.
  *
  *  (#) RESUMO:
  *      (+) Em condicoes normais, os reles nao estao atuados.
  *      (+) Posicao do MUX padrao: sinais da UPA.
  *      (+) Recebimento de PWM indicativo de estado de funcionamento:
  *        - Feito por meio de pinos de interrupcao externa.
  *        - A interrupcao zera contadores.
  *        - Se os contadores ultrapassarem um limite (timeout),
  *          e entendido como falha.
  *        - Uma callback ocorre a cada overflow do timer 16 (1 ms).
  *        - Nessa callback, e feito o monitoramento e a
  *          identificacao de falhas.
  *        - Falha ESP: +1, Falha UPA: +2, Falha CPU: +5.
  *          Ex.: Falha de numero 7 = Falha UPA e CPU (5 + 2)
  *
  *      (+) Condicoes de atuacao:
  *        - Falha da UPA
  *        - Falha do CPU
  *        - Falha de ambos
  *        - Ordem direta do controlador (botao de emergencia)
  *        - Com ordem direta do CPU
  *      (+) Na atuacao, o rele atua e envia para ECM os PWM gerados,
  *      	 em conjunto com a troca da posicao do MUX (STM).
  *      (+) Um menu de configuracao pode ser acessado.
  *        - Os parametros configurados podem ser salvos na flash.
  *        - Os parametros configurados podem ser apagados da flash.
  *      (+) Eventualidades sao informadas a qualquer momento por UART4,
  *          contendo timestamp (tempo apos inicio do funcionamento).
  *      (+) Conexao:
  *        - Recebe PING do transmissor na torre de controle.
  *        - Responde PONG ao transmissor.
  *        - Se parar de receber PING, indica perda de conexao do STM.
  *      (+) A placa possui sistema preventivo de queda de energia.
  *        - Se o sistema perder a alimentacao que vem da bateria
  *      	 do caminhao, uma bateria reserva em paralelo, protegida
  *      	 por um diodo, passa a alimentar o sistema, para mante-lo
  *      	 em devido funcionamento.
  *        - Se perder a alimentacao do caminhao, uma mensagem sera
  *        	 enviada remotamente ao controlador na torre de controle.
  *        - Com falha dos demais componentes do autonomo (UPA e CPU)
  *          o STM32 ira frear de imediato.
  *

Codes were written in the C and C++ languages, according to the
ANSI C/C++ (American National Standards Institute) standard. Additionally, the page

front-end of SEMA, saved in flash with the name “index_html”, was written using
HTML, CSS and JavaScript language. The STM32L4 microcontroller firmware
was written in C language, using hardware abstraction layer (HAL),
in the STM32Cube IDE. The ESP32 firmware was written in C++ on the platform
Espressif PlatformIO.
